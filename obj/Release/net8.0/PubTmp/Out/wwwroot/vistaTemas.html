<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="scripts/style_vistaTemas.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a085">
    <title>Temas</title>
</head>
<body>
    <h1>Todos los temas</h1>
    <main class="boteUno">

        <section class="retoHoy">
            <img src="images/flama.png" />
            <div class="temma">
                <h4>Cargando...</h4>
                <p><i>0</i> de <i>10</i> palabras completas</p>
            </div>
            <q>Cargando...</q>
            <div class="progress-container">
                <div class="progress-bar" style="width: 60%;"></div>
            </div>
            <samp>
                <time datetime="24-11-2025">Cargando...</time>
                <data value="0">Cargando...</data>
            </samp>
            <p id="desafio">¡Desafio especial de hoy!</p>
        </section>
        <div class="search-box">
            <input type="text" />
            <span class="search-icon"><img src="images/lupa.png" /></span>
        </div>
        <p>1 resultado encontrado</p>
        <div class="cartas-con">
            <!--se hace desde js-->
        </div>
    </main>
    <footer>
        <a href="#">
            <img src="images/Flecha.png" />
            <p>Regresar</p>
        </a>
    </footer>
    <script>
        //Verificar autenticación
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        let pageNumber = 1;
        let todosLosTemas = [];

        // ============================================
        // FETCH CON RENOVACIÓN AUTOMÁTICA DE TOKEN
        // ============================================
        async function fetchConToken(url, options = {}) {
            // Primera petición
            let response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
            });

            // Si es 401, renovar token y reintentar UNA sola vez
            if (response.status === 401) {
                const renewResponse = await fetch('/api/Auth/renew', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (renewResponse.ok) {
                    const nuevoToken = await renewResponse.text();
                    localStorage.setItem('jwtToken', nuevoToken);
                    // Reintentar con nuevo token
                    response = await fetch(url, {
                        ...options,
                        headers: {
                            ...options.headers,
                            'Authorization': `Bearer ${nuevoToken}`
                        }
                    });
                } else {
                    // No se pudo renovar, cerrar sesión
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            }

            return response;
        }

        // ============================================
        // INDEXEDDB - COMPLETO
        // ============================================
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ahorcaditoDB', 3);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('temas')) {
                        db.createObjectStore('temas', { keyPath: 'idTema' });
                    }

                    if (!db.objectStoreNames.contains('progreso-local')) {
                        db.createObjectStore('progreso-local', { keyPath: 'idTema' });
                    }
                };
            });
        }
        // ============================================
        // VERIFICAR SI HUBO REINICIO (RETORNA TRUE SI HUBO REINICIO)
        // ============================================
        async function verificarReinicio() {
            const db = await openIndexedDB();

            // 1️⃣ VERIFICAR SI HAY REINICIO PENDIENTE
            if (db.objectStoreNames.contains('pending-requests')) {
                const txPending = db.transaction(['pending-requests'], 'readonly');
                const storePending = txPending.objectStore('pending-requests');

                const peticionesPendientes = await new Promise((resolve, reject) => {
                    const request = storePending.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });

                const hayReinicioPendiente = peticionesPendientes.some(p =>
                    p.url && p.url.includes('/reiniciar-progreso')
                );

                if (hayReinicioPendiente) {
                    // VERIFICAR SI YA HICIMOS LA LIMPIEZA LOCAL PARA ESTE REINICIO
                    const yaLimpiado = localStorage.getItem('reinicio_local_ejecutado');

                    if (!yaLimpiado) {
                        await aplicarLimpiezaLocal(db);
                        localStorage.setItem('reinicio_local_ejecutado', 'true');
                        return true;
                    } else {
                        return false; // Ya no limpiamos, permitimos que el progreso nuevo se vea
                    }
                }
            }
            localStorage.removeItem('reinicio_local_ejecutado');
            if (!navigator.onLine) {
                return false;
            }

            try {
                const response = await fetchConToken('/api/Temas/verificar-reinicio', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.todasEnCero) {
                        await aplicarLimpiezaLocal(db);
                        return true; //RETORNAR TRUE
                    }
                }
            } catch (error) {
            }

            return false; // NO HUBO REINICIO
        }

        // ============================================
        // APLICAR LIMPIEZA LOCAL (FUNCIÓN REUTILIZABLE)
        // ============================================
        async function aplicarLimpiezaLocal(db) {
            // Limpiar progreso local
            if (db.objectStoreNames.contains('progreso-local')) {
                const tx1 = db.transaction(['progreso-local'], 'readwrite');
                await tx1.objectStore('progreso-local').clear();
            }

            // Resetear temas
            if (db.objectStoreNames.contains('temas')) {
                const tx2 = db.transaction(['temas'], 'readwrite');
                const store = tx2.objectStore('temas');

                const temas = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });

                for (const tema of temas) {
                    tema.palabrasCompletadas = 0;
                    tema.porcentajeProgreso = 0;
                    tema.palabrasServidorOriginal = 0;
                    await store.put(tema);
                }
            }
        }

        // ============================================
        // CARGAR TEMAS (CON VERIFICACIÓN DE REINICIO)
        // ============================================
        async function cargarTemas() {
            // CAPTURAR SI HUBO REINICIO
            const huboReinicio = await verificarReinicio();

            try {
                const response = await fetchConToken(`/api/Temas/pagina/${pageNumber}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const temas = await response.json();

                    //SI HUBO REINICIO: NO APLICAR PROGRESO LOCAL
                    const temasConProgresoLocal = await aplicarProgresoLocal(temas);

                    todosLosTemas = temasConProgresoLocal;

                    // GUARDAR EN CACHE (con progreso correcto)
                    await guardarTemasEnCache(temasConProgresoLocal);

                    mostrarTemas(temasConProgresoLocal);
                } else if (response.status === 401) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            } catch (error) {

                if (!navigator.onLine) {
                    const temasCache = await cargarTemasDesdeCache();

                    if (temasCache.length > 0) {
                        // EN OFFLINE, SI HUBO REINICIO, USAR CACHE YA LIMPIO
                        const temasConProgresoLocal = huboReinicio
                            ? temasCache  // Ya fueron limpiados por aplicarLimpiezaLocal()
                            : await aplicarProgresoLocal(temasCache);

                        todosLosTemas = temasConProgresoLocal;
                        mostrarTemas(temasConProgresoLocal);
                        mostrarMensajeOffline();
                    } else {
                        alert('No hay temas disponibles offline');
                    }
                } else {
                    alert('Error de conexión');
                }
            }
        }

        // ============================================
        // APLICAR PROGRESO LOCAL A TEMAS
        // ============================================
        async function aplicarProgresoLocal(temas) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['progreso-local'], 'readonly');
                const store = transaction.objectStore('progreso-local');

                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const progresosLocales = request.result || [];

                        // Aplicar progreso local a cada tema
                        const temasActualizados = temas.map(tema => {
                            const progresoLocal = progresosLocales.find(p => p.idTema === tema.idTema);

                            // 1. SIEMPRE guardamos el valor original del servidor antes de tocar nada
                            // Si ya existe (porque viene del cache), lo mantenemos. Si no, usamos el actual.
                            const serverVal = tema.palabrasServidorOriginal !== undefined
                                ? tema.palabrasServidorOriginal
                                : tema.palabrasCompletadas;

                            if (progresoLocal && progresoLocal.palabrasCompletadas > tema.palabrasCompletadas) {
                                return {
                                    ...tema,
                                    palabrasServidorOriginal: serverVal,
                                    palabrasCompletadas: progresoLocal.palabrasCompletadas,
                                    porcentajeProgreso: (progresoLocal.palabrasCompletadas / 10) * 100
                                };
                            }
                            // Aunque no haya progreso local superior, aseguramos la estructura
                            return {
                                ...tema,
                                palabrasServidorOriginal: serverVal
                            };
                        });

                        resolve(temasActualizados);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return temas;
            }
        }

        function mostrarMensajeOffline() {
            const mensaje = document.createElement('div');
            mensaje.style.cssText = `
                        position: fixed;
                        top: 10px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #e74c3c;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        z-index: 1000;
                    `;
            mensaje.textContent = '📡 Modo Offline - Mostrando temas descargados';
            document.body.appendChild(mensaje);

            setTimeout(() => mensaje.remove(), 5000);
        }

        // ============================================
        // SOPORTE OFFLINE PARA TEMAS
        // ============================================
        async function guardarTemasEnCache(temas) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readwrite');
                const store = transaction.objectStore('temas');

                for (const tema of temas) {
                    await store.put(tema);
                }

            } catch (error) {
            }
        }

        async function cargarTemasDesdeCache() {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readonly');
                const store = transaction.objectStore('temas');

                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return [];
            }
        }

        //Mostrar temas en el DOM
        function mostrarTemas(temas) {
            const container = document.querySelector('.cartas-con');
            const retoHoy = document.querySelector('.retoHoy');
            const resultadoText = document.querySelector('main > p');

            // Limpiar contenedor
            container.innerHTML = '';

            if (temas.length === 0) {
                resultadoText.textContent = 'No hay temas disponibles';
                return;
            }

            // Mostrar reto del día (primer tema)
            const temaDiario = temas[0];
            retoHoy.querySelector('.temma h4').textContent = temaDiario.nombre;
            retoHoy.querySelector('.temma p').innerHTML = `<i>${temaDiario.palabrasCompletadas}</i> de <i>10</i> palabras completas`;
            retoHoy.querySelector('q').textContent = temaDiario.descripcion;
            retoHoy.querySelector('.progress-bar').style.width = temaDiario.porcentajeProgreso + '%';
            retoHoy.querySelector('time').textContent = new Date(temaDiario.fechaGeneracion).toLocaleDateString('es-MX');
            retoHoy.querySelector('data').textContent = Math.round(temaDiario.porcentajeProgreso) + '%';

            // Click en reto diario
            retoHoy.style.cursor = 'pointer';

            retoHoy.onclick = async () => {
                // 1. Asegurar persistencia en IndexedDB antes de navegar
                try {
                    const db = await openIndexedDB();
                    const tx = db.transaction(['temas'], 'readwrite');
                    const store = tx.objectStore('temas');
                    store.put(temaDiario); // Forzamos el guardado/actualización del tema seleccionado
                } catch (e) {
                }

                // 2. Flujo normal
                sessionStorage.setItem('temaSeleccionado', JSON.stringify(temaDiario));
                sessionStorage.setItem('esRetoDiario', 'true');
                window.location.href = 'juego.html';
            };

            // Mostrar resto de temas
            temas.forEach(tema => {
                const card = document.createElement('section');
                card.className = 'cartas';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                            <img src="images/control.png" />
                            <div class="temma-cartas">
                                <h4>${tema.nombre}</h4>
                                <p><i>${tema.palabrasCompletadas}</i> de <i>10</i> palabras completas</p>
                            </div>
                            <q>${tema.descripcion}</q>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${tema.porcentajeProgreso}%;"></div>
                            </div>
                            <samp>
                                <time datetime="${tema.fechaGeneracion}">${new Date(tema.fechaGeneracion).toLocaleDateString('es-MX')}</time>
                                <data value="${tema.palabrasCompletadas}">${Math.round(tema.porcentajeProgreso)}%</data>
                            </samp>
                        `;

                card.onclick = async () => {
                    // 1. Asegurar persistencia
                    try {
                        const db = await openIndexedDB();
                        const tx = db.transaction(['temas'], 'readwrite');
                        const store = tx.objectStore('temas');
                        store.put(tema);
                    } catch (e) { console.error(e); }

                    // 2. Navegar
                    sessionStorage.setItem('temaSeleccionado', JSON.stringify(tema));
                    sessionStorage.setItem('esRetoDiario', 'false');
                    window.location.href = 'juego.html';
                };

                container.appendChild(card);
            });

            resultadoText.textContent = `${temas.length} resultado${temas.length !== 1 ? 's' : ''} encontrado${temas.length !== 1 ? 's' : ''}`;
        }

        //Buscar temas
        const searchInput = document.querySelector('.search-box input');
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            if (query === '') {
                mostrarTemas(todosLosTemas);
            } else {
                const filtrados = todosLosTemas.filter(tema =>
                    tema.nombre.toLowerCase().includes(query) ||
                    tema.descripcion.toLowerCase().includes(query)
                );
                mostrarTemas(filtrados);
            }
        });

        // Botón regresar
        document.querySelector('footer a').addEventListener('click', function (e) {
            window.location.href = "index.html"
        });

        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                // La página se volvió visible (el usuario regresó)
                cargarTemas();
            }
        });

        window.addEventListener('pageshow', function (event) {
            // Si viene del caché (botón atrás), recargar
            if (event.persisted) {
                cargarTemas();
            }
        });

        window.addEventListener('focus', function () {
            cargarTemas();
        });

        // Cargar temas al iniciar
        document.addEventListener('DOMContentLoaded', cargarTemas);
    </script>

</body>

</html>