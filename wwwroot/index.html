<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="scripts/style_temaIndex.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
</head>
<body>
    <header>
        <nav>
            <p>Notificaciones</p>
            <a href="#">
                <img src="images/Notificaciones.png" />
            </a>
        </nav>
    </header>
    <main>
        <div class="titulo">
            <img src="images/hangman-6.svg" />
            <h1>El AHORCADITO</h1>
        </div>
        <div class="btns">
            <button id="naranja"><img src="images/flama.png" />¡Jugar Reto de hoy!</button>
            <div class="btn">
                <button id="todosLosTemas"><img src="images/triangulo.png">Todos los temas</button>
                <button id="racha"><img src="images/rayo.png">Racha</button>
            </div>
            <button id="perfil"><img src="images/usuario.png" />Mi perfil</button>
        </div>
    </main>
    <script>
        // ✅ Verificar autenticación
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        // ✅ Función para renovar token si es necesario
        async function verificarYRenovarToken() {
            try {
                const response = await fetch('/api/Auth/renew', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const newToken = await response.text();
                    localStorage.setItem('jwtToken', newToken);
                    return newToken;
                } else {
                    // Token expirado, redirigir a login
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                    return null;
                }
            } catch (error) {
                console.error('Error renovando token:', error);
                return token;
            }
        }

        //// Cargar notificaciones pendientes (contador)
        //async function cargarNotificaciones() {
        //    try {
        //        const response = await fetch('/api/Notificaciones/pendientes', {
        //            headers: { 'Authorization': `Bearer ${token}` }
        //        });

        //        if (response.ok) {
        //            const notificaciones = await response.json();
        //            const badge = document.getElementById('badge-notificaciones');

        //            if (notificaciones && notificaciones.length > 0) {
        //                badge.textContent = notificaciones.length;
        //                badge.style.display = 'inline-block';
        //            } else {
        //                badge.style.display = 'none';
        //            }
        //        } else if (response.status === 401) {
        //            await verificarYRenovarToken();
        //        }
        //    } catch (error) {
        //        console.error('Error cargando notificaciones:', error);
        //    }
        //}

        // ✅ Iniciar reto diario
        document.getElementById('naranja').addEventListener('click', async function (e) {
            e.preventDefault();

            try {
                const response = await fetch('/api/Juego/iniciar-diario', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const retoDiario = await response.json();

                    // Guardar tema en sessionStorage
                    const temaParaJuego = {
                        idTema: retoDiario.idTema,
                        nombre: retoDiario.nombreTema,
                        descripcion: `Reto diario del día`,
                        palabrasCompletadas: retoDiario.palabrasCompletadas,
                        totalPalabras: retoDiario.totalPalabras,
                        porcentajeProgreso: (retoDiario.palabrasCompletadas / retoDiario.totalPalabras) * 100,
                        palabrasCifradas: [] // Se llenará en juego.html
                    };

                    sessionStorage.setItem('temaSeleccionado', JSON.stringify(temaParaJuego));
                    sessionStorage.setItem('esRetoDiario', 'true');

                    // Verificar si ya completó el reto
                    if (retoDiario.yaCompletadoHoy) {
                        alert('¡Ya completaste el reto de hoy! Vuelve mañana para un nuevo desafío.');
                        return;
                    }

                    window.location.href = 'juego.html';
                } else if (response.status === 401) {
                    await verificarYRenovarToken();
                    this.click(); // Reintentar
                } else {
                    alert('Error al cargar el reto diario');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión al cargar el reto');
            }
        });

        // ✅ Ver todos los temas
        document.getElementById("todosLosTemas").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'vistaTemas.html';
        });

        // ✅ Ver racha
        document.getElementById("racha").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'racha.html';
        });

        // ✅ Ver perfil
        document.getElementById("perfil").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'perfil.html';
        });

        //// Cargar notificaciones al iniciar
        //document.addEventListener('DOMContentLoaded', function () {
        //    cargarNotificaciones();

        //    // Actualizar notificaciones cada 30 segundos
        //    setInterval(cargarNotificaciones, 30000);
        //});

        // ✅ Verificar token al cargar la página
        verificarYRenovarToken();
    </script>
</body>
</html>