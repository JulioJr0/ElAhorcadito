<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ahorcadito Juego</title>
    <link rel="stylesheet" href="scripts/style.css">

</head>
<body>
    <audio id="background-music" loop>
        <source src="images/gaming-game-minecraft-background-music-372242.mp3" type="audio/mpeg">
    </audio>

    <div class="game-modal">
        <div class="content">
            <img src="images/lost.gif" alt="fig">
            <h4>Game Over!</h4>
            <p>The correct word was: <b>rainbow</b></p>
            <button class="play-again">Siguiente Palabra</button>
        </div>
    </div>

    <div class="container">
        <div class="game-header">
            <button class="btn-regresar">
                ‚Üê Regresar
            </button>
            <div class="reto-badge" id="reto-badge" style="display:none;">
                <span>‚≠ê</span> ¬°Reto de Hoy!
            </div>
        </div>

        <div class="hangman-box">
            <img src="images/hangman-0.svg" alt="hangman-img">
            <h1>EL AHORCADITO</h1>
        </div>

        <div class="game-box">
            <ul class="word-display"></ul>
            <div class="hearts-container">
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
            </div>
            <div class="game-info">
                <h4 class="tema-text">Tema: <b id="tema-nombre">Cargando...</b></h4>
                <h4 class="progreso-text">Palabra <b id="palabra-actual">0</b> de <b id="total-palabras">10</b></h4>
            </div>
            <!-- Teclado -->
            <div class="keyboard"></div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        const temaSeleccionado = JSON.parse(sessionStorage.getItem('temaSeleccionado'));
        const esRetoDiario = sessionStorage.getItem('esRetoDiario') === 'true';

        if (!temaSeleccionado) {
            alert('No se seleccion√≥ ning√∫n tema');
            window.location.href = 'vistaTemas.html';
        }

        const hangmanImage = document.querySelector(".hangman-box img");
        const wordDisplay = document.querySelector(".word-display");
        const keyboardDiv = document.querySelector(".keyboard");
        const gameModal = document.querySelector(".game-modal");
        const playAgainBtn = document.querySelector(".play-again");
        const heartsContainer = document.querySelector(".hearts-container");
        const retoBadge = document.getElementById("reto-badge");
        const temaNombre = document.getElementById("tema-nombre");
        const palabraActualEl = document.getElementById("palabra-actual");
        const totalPalabrasEl = document.getElementById("total-palabras");

        const backgroundMusic = document.getElementById('background-music');
        let sonidosActivados = false;

        let currentWord, correctLetters, wrongGuessCount;
        const maxGuesses = 6;
        let palabrasCifradas = [];
        let palabraIndex = 0;
        let palabrasDelTema = [];

        async function cargarPreferencias() {
            try {
                const response = await fetch('/api/Auth/perfil', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const perfil = await response.json();
                    sonidosActivados = perfil.sonidosActivados;

                    // Reproducir m√∫sica de fondo si est√° activada
                    if (sonidosActivados) {
                        backgroundMusic.volume = 0.3; // Volumen al 30%
                        backgroundMusic.play().catch(err => {
                            console.log('No se pudo reproducir autom√°ticamente:', err);
                        });
                    }
                } else if (response.status === 401) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error cargando preferencias:', error);
            }
        }

        document.querySelector(".btn-regresar").addEventListener("click", function (e) {
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
            window.location.href = 'vistaTemas.html';
        });
        //descifrar Base64
        function descifrarPalabra(palabraCifrada) {
            try {
                return atob(palabraCifrada);
            } catch (e) {
                console.error('Error descifrando palabra:', e);
                return '';
            }
        }

        //Actualizar UI del tema
        function actualizarInfoTema() {
            temaNombre.textContent = temaSeleccionado.nombre;
            palabraActualEl.textContent = palabraIndex + 1;
            totalPalabrasEl.textContent = temaSeleccionado.totalPalabras || 10;

            if (esRetoDiario) {
                retoBadge.style.display = 'flex';
            }
        }

        //Actualizar corazones seg√∫n intentos fallidos
        function actualizarCorazones() {
            const hearts = heartsContainer.querySelectorAll('.heart');
            hearts.forEach((heart, index) => {
                if (index < maxGuesses - wrongGuessCount) {
                    heart.style.opacity = '1';
                    heart.textContent = '‚ù§Ô∏è';
                } else {
                    heart.style.opacity = '0.3';
                    heart.textContent = 'üñ§';
                }
            });
        }

        //Resetear el juego
        const resetGame = () => {
            correctLetters = [];
            wrongGuessCount = 0;
            hangmanImage.src = `images/hangman-${wrongGuessCount}.svg`;
            keyboardDiv.querySelectorAll("button").forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('correct', 'incorrect');
            });
            wordDisplay.innerHTML = currentWord.split("").map(() => `<li class="letter"></li>`).join("");
            gameModal.classList.remove("show");
            actualizarCorazones();
            actualizarInfoTema();
        }

        //Cargar palabras del tema desde la API
        async function cargarPalabrasTema() {
            try {
                //Si es reto diario, obtener datos desde el endpoint
                if (esRetoDiario) {
                    const response = await fetch('/api/Juego/iniciar-diario', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const retoDiario = await response.json();

                        if (retoDiario.yaCompletadoHoy) {
                            alert('¬°Ya completaste el reto de hoy! Vuelve ma√±ana.');
                            window.location.href = 'index.html';
                            return;
                        }

                        //Usar la palabra del reto diario
                        palabraIndex = retoDiario.palabraActualIndex;
                        currentWord = retoDiario.palabraAdivinar;

                        //Actualizar info del tema
                        temaSeleccionado.palabrasCompletadas = retoDiario.palabrasCompletadas;

                    } else if (response.status === 401) {
                        localStorage.removeItem('jwtToken');
                        window.location.href = 'login.html';
                        return;
                    }
                } else {
                    // Tema normal: usar palabras cifradas
                    palabrasCifradas = temaSeleccionado.palabrasCifradas || [];
                    palabraIndex = temaSeleccionado.palabrasCompletadas || 0;

                    if (palabraIndex >= palabrasCifradas.length) {
                        alert('¬°Ya completaste todas las palabras de este tema!');
                        window.location.href = 'vistaTemas.html';
                        return;
                    }

                    //Descifrar todas las palabras
                    palabrasDelTema = palabrasCifradas.map(p => descifrarPalabra(p));
                    currentWord = palabrasDelTema[palabraIndex];
                }

                if (!currentWord || currentWord === '') {
                    alert('Error al cargar la palabra');
                    window.location.href = 'vistaTemas.html';
                    return;
                }

                console.log('Palabra cargada:', currentWord);
                resetGame();

            } catch (error) {
                console.error('Error cargando palabras:', error);
                alert('Error de conexi√≥n al cargar el juego');
            }
        }

        //Actualizar progreso en la API
        async function actualizarProgreso(resultado) {
            try {
                const response = await fetch('/api/Juego/actualizar-progreso', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        idTema: temaSeleccionado.idTema,
                        palabraActualIndex: palabraIndex,
                        resultado: resultado
                    })
                });

                if (response.ok) {
                    console.log('Progreso actualizado:', resultado);
                    if (resultado === 'GANADA') {
                        palabraIndex++;
                        temaSeleccionado.palabrasCompletadas++;
                    }
                } else if (response.status === 401) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error actualizando progreso:', error);
            }
        }

        //Game Over
        const gameOver = async (isVictory) => {
            setTimeout(async () => {
                const modalText = isVictory ? `¬°Encontraste la palabra:` : `La palabra correcta era:`;
                gameModal.querySelector("img").src = `images/${isVictory ? `victory` : `lost`}.gif`;
                gameModal.querySelector("h4").innerText = `${isVictory ? `¬°Felicidades!` : `Game Over!`}`;
                gameModal.querySelector("p").innerHTML = `${modalText} <b>${currentWord.toUpperCase()}</b>`;
                gameModal.classList.add("show");

                //Actualizar progreso en la API
                if (isVictory) {
                    await actualizarProgreso('GANADA');
                } else {
                    await actualizarProgreso('PERDIDA');
                }
            }, 300);
        }

        //Iniciar juego con letra clickeada
        const initGame = (button, clickedLetter) => {
            //Revisar si la letra existe en la palabra
            if (currentWord.toLowerCase().includes(clickedLetter)) {
                button.classList.add('correct');
                //Mostrar todas las letras correctas
                [...currentWord.toLowerCase()].forEach((letter, index) => {
                    if (letter === clickedLetter) {
                        correctLetters.push(letter);
                        wordDisplay.querySelectorAll("li")[index].innerText = currentWord[index].toUpperCase();
                        wordDisplay.querySelectorAll("li")[index].classList.add("guessed");
                    }
                });
            } else {
                //Letra incorrecta: aumentar contador y actualizar imagen
                button.classList.add('incorrect');
                wrongGuessCount++;
                hangmanImage.src = `images/hangman-${wrongGuessCount}.svg`;
                actualizarCorazones();
            }

            button.disabled = true;

            //Verificar condiciones de fin de juego
            if (wrongGuessCount === maxGuesses) return gameOver(false);
            if (correctLetters.length === currentWord.length) return gameOver(true);
        }

        //Crear teclado
        for (let i = 97; i <= 110; i++) {
            const char = String.fromCharCode(i);
            const button = document.createElement("button");
            button.innerText = char.toUpperCase();
            keyboardDiv.appendChild(button);
            button.addEventListener("click", e => initGame(e.target, char));
        }

        //letra √±
        const buttonNtilde = document.createElement("button");
        buttonNtilde.innerText = "√ë";
        keyboardDiv.appendChild(buttonNtilde);
        buttonNtilde.addEventListener("click", e => initGame(e.target, "√±"));

        for (let i = 111; i <= 122; i++) {
            const char = String.fromCharCode(i);
            const button = document.createElement("button");
            button.innerText = char.toUpperCase();
            keyboardDiv.appendChild(button);
            button.addEventListener("click", e => initGame(e.target, char));
        }

        //Bot√≥n "Siguiente Palabra"
        playAgainBtn.addEventListener("click", async function () {
            //Verificar si hay m√°s palabras
            if (esRetoDiario) {
                //En reto diario, cargar nueva palabra desde API
                await cargarPalabrasTema();
            } else {
                //En temas normales, avanzar a siguiente palabra
                if (palabraIndex < palabrasDelTema.length) {
                    currentWord = palabrasDelTema[palabraIndex];
                    resetGame();
                } else {
                    alert('¬°Completaste todas las palabras de este tema!');
                    sessionStorage.removeItem('temaSeleccionado');
                    sessionStorage.removeItem('esRetoDiario');

                    if (backgroundMusic) {
                        backgroundMusic.pause();
                        backgroundMusic.currentTime = 0;
                    }

                    window.location.href = 'vistaTemas.html';
                }
            }
        });

        //Inicializar juego al cargar
        document.addEventListener('DOMContentLoaded', function () {
            cargarPreferencias();
            cargarPalabrasTema();
        });

        window.addEventListener('beforeunload', function () {
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        });
    </script>
</body>
</html>