<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="scripts/style_temaIndex.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#16a085">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="images/android/android-launchericon-192-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a085">
    <title>El Ahorcadito</title>
    <style>
        /* Toast para notificaciones in-app */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

            #toast.show {
                visibility: visible;
                animation: fadein 0.5s, fadeout 0.5s 2.5s;
            }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* Badge de notificaciones */
        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

            .notif-badge.active {
                display: flex;
            }

        /* Indicador de conexión */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
            display: none;
        }

            .connection-status.offline {
                background: #e74c3c;
                color: white;
                display: block;
            }

            .connection-status.online {
                background: #27ae60;
                color: white;
                display: block;
                animation: fadeout 0.5s 2s forwards;
            }
    </style>
</head>
<body>
    <!-- Indicador de conexión -->
    <div id="connection-status" class="connection-status"></div>

    <!-- Toast para notificaciones -->
    <div id="toast"></div>

    <header>
        <nav>
            <p>Notificaciones</p>
            <a href="notificaciones.html" style="position: relative;">
                <img src="images/Notificaciones.png" />
                <span id="notif-badge" class="notif-badge">0</span>
            </a>
        </nav>
    </header>
    <main>
        <div class="titulo">
            <img src="images/hangman-6.svg" />
            <h1>El AHORCADITO</h1>
        </div>
        <div class="btns">
            <button id="naranja"><img src="images/flama.png" />¡Jugar Reto de hoy!</button>
            <div class="btn">
                <button id="todosLosTemas"><img src="images/triangulo.png">Todos los temas</button>
                <button id="racha"><img src="images/rayo.png">Racha</button>
            </div>
            <button id="perfil"><img src="images/usuario.png" />Mi perfil</button>
        </div>
    </main>
    <script>
        // ============================================
        // VERIFICACIÓN DE AUTENTICACIÓN
        // ============================================
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        // ============================================
        // INDEXEDDB HELPER FUNCTIONS (AGREGAR AL INICIO DEL SCRIPT)
        // ============================================
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ahorcaditoDB', 3);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('temas')) {
                        db.createObjectStore('temas', { keyPath: 'idTema' });
                    }

                    if (!db.objectStoreNames.contains('progreso-local')) {
                        db.createObjectStore('progreso-local', { keyPath: 'idTema' });
                    }
                };
            });
        }

        async function guardarTemaEnIndexedDB(tema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readwrite');
                const store = transaction.objectStore('temas');

                await new Promise((resolve, reject) => {
                    const request = store.put(tema);
                    request.onsuccess = () => {
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
            }
        }

        async function cargarTemaDesdeIndexedDB(idTema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readonly');
                const store = transaction.objectStore('temas');

                return new Promise((resolve, reject) => {
                    const request = store.get(idTema);
                    request.onsuccess = () => {
                        const tema = request.result;
                        if (tema) {
                        }
                        resolve(tema || null);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return null;
            }
        }

        async function cargarProgresoLocal(idTema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['progreso-local'], 'readonly');
                const store = transaction.objectStore('progreso-local');

                return new Promise((resolve, reject) => {
                    const request = store.get(idTema);
                    request.onsuccess = () => {
                        const progreso = request.result;
                        if (progreso) {
                        }
                        resolve(progreso || null);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return null;
            }
        }

        // ============================================
        // REGISTRO DE SERVICE WORKER Y PUSH
        // ============================================
        let swRegistration = null;
        let suscripcionActiva = false;

        async function inicializarPWA() {
            if (!('serviceWorker' in navigator)) {
                return;
            }

            try {
                // 1. Registrar Service Worker
                swRegistration = await navigator.serviceWorker.register('/sw.js?v=3');

                // 2. Esperar a que esté activo
                await navigator.serviceWorker.ready;

                // 3. Inicializar notificaciones push
                await inicializarPush();

                // 4. Escuchar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', manejarMensajeSW);

                // 5. Detectar cambios de conexión
                window.addEventListener('online', manejarOnline);
                window.addEventListener('offline', manejarOffline);

                // 6. Sincronizar al cargar
                if (navigator.onLine) {
                    await sincronizarDatos();
                }

            } catch (error) {
            }
        }

        // ============================================
        // NOTIFICACIONES PUSH - ARREGLADO
        // ============================================
        async function inicializarPush() {
            if (!('PushManager' in window)) {
                return;
            }

            if (!('Notification' in window)) {
                return;
            }

            try {

                // 1. Verificar permiso actual
                let permission = Notification.permission;

                // 2. Si no se ha preguntado, solicitar permiso
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }

                // 3. Si se denegó el permiso
                if (permission === 'denied') {
                    return;
                }

                // 4. Si se concedió el permiso
                if (permission === 'granted') {

                    // 5. Obtener clave pública VAPID
                    const response = await fetch('/api/Notificaciones/publickey');

                    if (!response.ok) {
                        return;
                    }

                    const publicKey = await response.text();

                    // 6. Verificar suscripción existente
                    let subscription = await swRegistration.pushManager.getSubscription();

                    if (subscription) {
                    } else {
                        // 7. Crear nueva suscripción
                        subscription = await swRegistration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(publicKey)
                        });
                    }

                    // 8. Enviar suscripción al servidor
                    const suscripcionResponse = await fetch('/api/Notificaciones/suscribir', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(subscription)
                    });

                    if (suscripcionResponse.ok) {
                        suscripcionActiva = true;

                    } else {
                        const errorText = await suscripcionResponse.text();
                    }

                }

            } catch (error) {
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // ============================================
        // MANEJO DE MENSAJES DEL SERVICE WORKER
        // ============================================
        function manejarMensajeSW(event) {
            const { type, titulo, mensaje } = event.data;

            switch (type) {
                case 'NOTIFICACION_RECIBIDA':
                    mostrarToast(`${titulo}: ${mensaje}`);
                    actualizarContadorNotificaciones();
                    break;

                case 'SYNC_COMPLETE':
                    mostrarToast('Progreso sincronizado correctamente');
                    break;
            }
        }

        // ============================================
        // FUNCIONES DE CONEXIÓN
        // ============================================
        function manejarOnline() {
            mostrarEstadoConexion('Conectado', 'online');
            sincronizarDatos();
        }

        function manejarOffline() {
            mostrarEstadoConexion('Sin conexión - Modo offline', 'offline');
        }

        function mostrarEstadoConexion(mensaje, estado) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.textContent = mensaje;
            statusDiv.className = `connection-status ${estado}`;
        }

        // ============================================
        // SINCRONIZACIÓN DE DATOS
        // ============================================
        async function sincronizarDatos() {
            try {
                if ('sync' in swRegistration) {
                    await swRegistration.sync.register('sync-data');
                }
            } catch (error) {
            }
        }

        // ============================================
        // CONTADOR DE NOTIFICACIONES
        // ============================================
        async function actualizarContadorNotificaciones() {
            try {
                const response = await fetch('/api/Notificaciones/contar-no-leidas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notif-badge');

                    if (data.noLeidas > 0) {
                        badge.textContent = data.noLeidas > 9 ? '9+' : data.noLeidas;
                        badge.classList.add('active');
                    } else {
                        badge.classList.remove('active');
                    }
                }
            } catch (error) {
            }
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function mostrarToast(mensaje) {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // RENOVACIÓN DE TOKEN
        // ============================================
        async function verificarYRenovarToken() {
            try {
                const response = await fetch('/api/Auth/renew', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const newToken = await response.text();
                    localStorage.setItem('jwtToken', newToken);
                    return newToken;
                } else {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                    return null;
                }
            } catch (error) {
                return token;
            }
        }
        // ============================================
        // FETCH CON RENOVACIÓN AUTOMÁTICA DE TOKEN
        // ============================================
        async function fetchConToken(url, options = {}) {
            // Primera petición
            let response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
            });

            // Si es 401, renovar token y reintentar UNA sola vez
            if (response.status === 401) {
                const nuevoToken = await verificarYRenovarToken();

                if (nuevoToken) {
                    // Reintentar con nuevo token
                    response = await fetch(url, {
                        ...options,
                        headers: {
                            ...options.headers,
                            'Authorization': `Bearer ${nuevoToken}`
                        }
                    });
                }
            }

            return response;
        }

        // ============================================
        // NAVEGACIÓN - RETO DIARIO (CORREGIDO - SIN CACHE)
        // ============================================
        document.getElementById('naranja').addEventListener('click', async function (e) {
            e.preventDefault();

            try {
                // 1. Intentar cargar desde el servidor
                const response = await fetchConToken('/api/Juego/iniciar-diario', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const retoDiario = await response.json();

                    if (retoDiario.yaCompletadoHoy) {
                        mostrarToast('¡Ya completaste el reto de hoy! Vuelve mañana.');
                        return;
                    }

                    // 2. ✅ CARGAR PALABRAS CIFRADAS FORZANDO RED (SIN CACHE)
                    let palabrasCifradas = [];

                    try {
                        // ✅ USAR cache: 'no-cache' PARA FORZAR PETICIÓN AL SERVIDOR
                        const temaResponse = await fetchConToken(`/api/Temas/${retoDiario.idTema}`, {
                            cache: 'no-cache', // ⚠️ CRÍTICO: Evita que el SW devuelva cache viejo
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Cache-Control': 'no-cache'
                            }
                        });

                        if (temaResponse.ok) {
                            const temaCompleto = await temaResponse.json();
                            palabrasCifradas = temaCompleto.palabrasCifradas || [];
                            if (palabrasCifradas.length === 0) {
                            }
                        } else {
                        }
                    } catch (error) {
                        // Intentar desde cache como último recurso
                        const temaCache = await cargarTemaDesdeIndexedDB(retoDiario.idTema);
                        if (temaCache && temaCache.palabrasCifradas) {
                            palabrasCifradas = temaCache.palabrasCifradas;
                        }
                    }

                    // 3. ✅ VALIDAR QUE TENGA PALABRAS ANTES DE CONTINUAR
                    if (palabrasCifradas.length === 0) {
                        mostrarToast('Error al cargar el reto. Intenta de nuevo.');
                        return;
                    }

                    // 4. Verificar progreso local
                    const progresoLocal = await cargarProgresoLocal(retoDiario.idTema);

                    // 5. Usar el progreso más alto
                    let palabrasCompletadas = retoDiario.palabrasCompletadas;
                    if (progresoLocal && progresoLocal.palabrasCompletadas > retoDiario.palabrasCompletadas) {
                        palabrasCompletadas = progresoLocal.palabrasCompletadas;
                    }

                    // 6. Preparar tema para el juego
                    const temaParaJuego = {
                        idTema: retoDiario.idTema,
                        nombre: retoDiario.nombreTema,
                        descripcion: `Reto diario del día`,
                        palabrasCompletadas: palabrasCompletadas,
                        palabrasServidorOriginal: retoDiario.palabrasCompletadas,
                        totalPalabras: retoDiario.totalPalabras,
                        porcentajeProgreso: (palabrasCompletadas / retoDiario.totalPalabras) * 100,
                        palabrasCifradas: palabrasCifradas, 
                        fechaGeneracion: new Date().toISOString()
                    };

                    // 7. ✅ GUARDAR EN INDEXEDDB ANTES DE NAVEGAR
                    await guardarTemaEnIndexedDB(temaParaJuego);

                    // 8. Guardar en sessionStorage
                    sessionStorage.setItem('temaSeleccionado', JSON.stringify(temaParaJuego));
                    sessionStorage.setItem('esRetoDiario', 'true');

                    // 9. Navegar
                    window.location.href = 'juego.html';

                } else if (response.status === 401) {
                    await verificarYRenovarToken();
                    this.click();
                } else {
                    // Modo offline
                    await iniciarRetoDiarioOffline();
                }

            } catch (error) {

                // Modo offline
                if (!navigator.onLine) {
                    await iniciarRetoDiarioOffline();
                } else {
                    mostrarToast('Error de conexión al cargar el reto');
                }
            }
        });

        // ============================================
        // FUNCIÓN: INICIAR RETO DIARIO OFFLINE
        // ============================================
        async function iniciarRetoDiarioOffline() {
            try {
                const db = await openIndexedDB();

                // 1. Buscar el reto diario en temas guardados
                const transaction = db.transaction(['temas'], 'readonly');
                const store = transaction.objectStore('temas');

                const temas = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });

                // 2. El primer tema suele ser el reto diario
                const retoDiario = temas[0];

                if (!retoDiario) {
                    mostrarToast('No hay reto diario disponible offline');
                    window.location.href = 'vistaTemas.html';
                    return;
                }

                // 3. VERIFICAR QUE TENGA PALABRAS CIFRADAS
                if (!retoDiario.palabrasCifradas || retoDiario.palabrasCifradas.length === 0) {
                    mostrarToast('El reto diario no está disponible offline. Conéctate primero.');
                    window.location.href = 'vistaTemas.html';
                    return;
                }

                // 4. Verificar progreso local
                const progresoLocal = await cargarProgresoLocal(retoDiario.idTema);

                // 5. Preparar tema con progreso local si existe
                const temaParaJuego = {
                    ...retoDiario,
                    palabrasCompletadas: progresoLocal ? progresoLocal.palabrasCompletadas : retoDiario.palabrasCompletadas
                };

                // 6. Verificar si ya completó
                if (temaParaJuego.palabrasCompletadas >= 10) {
                    mostrarToast('¡Ya completaste el reto de hoy!');
                    return;
                }

                // 7. Guardar en sessionStorage
                sessionStorage.setItem('temaSeleccionado', JSON.stringify(temaParaJuego));
                sessionStorage.setItem('esRetoDiario', 'true');

                mostrarToast('Modo offline - Usando reto guardado');

                // 8. Navegar
                window.location.href = 'juego.html';

            } catch (error) {
                mostrarToast('No hay datos offline disponibles');
                window.location.href = 'vistaTemas.html';
            }
        }

        document.getElementById("todosLosTemas").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'vistaTemas.html';
        });

        document.getElementById("racha").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'racha.html';
        });

        document.getElementById("perfil").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = 'perfil.html';
        });

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', async function () {

            await inicializarPWA();
            await actualizarContadorNotificaciones();

            // Actualizar contador cada 30 segundos
            setInterval(actualizarContadorNotificaciones, 30000);
        });

        // Detectar si viene de un shortcut del manifest
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'reto') {
            document.getElementById('naranja').click();
        }
    </script>
</body>
</html>