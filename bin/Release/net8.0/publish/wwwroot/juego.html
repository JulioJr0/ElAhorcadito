<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a085">
    <title>Ahorcadito Juego</title>
    <link rel="stylesheet" href="scripts/style.css">

</head>
<body>
    <audio id="background-music" loop>
        <source src="images/gaming-game-minecraft-background-music-372242.mp3" type="audio/mpeg">
    </audio>

    <div class="game-modal">
        <div class="content">
            <img src="images/lost.gif" alt="fig">
            <h4>Game Over!</h4>
            <p>The correct word was: <b>rainbow</b></p>
            <button class="play-again">Siguiente Palabra</button>
        </div>
    </div>

    <div class="container">
        <div class="game-header">
            <button class="btn-regresar">
                ‚Üê Regresar
            </button>
            <div class="reto-badge" id="reto-badge" style="display:none;">
                <span>‚≠ê</span> ¬°Reto de Hoy!
            </div>
        </div>

        <div class="hangman-box">
            <img src="images/hangman-0.svg" alt="hangman-img">
            <h1>EL AHORCADITO</h1>
        </div>

        <div class="game-box">
            <ul class="word-display"></ul>
            <div class="hearts-container">
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
            </div>
            <div class="game-info">
                <h4 class="tema-text">Tema: <b id="tema-nombre">Cargando...</b></h4>
                <h4 class="progreso-text">Palabra <b id="palabra-actual">0</b> de <b id="total-palabras">10</b></h4>
            </div>
            <!-- Teclado -->
            <div class="keyboard"></div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        const temaSeleccionado = JSON.parse(sessionStorage.getItem('temaSeleccionado'));
        const esRetoDiario = sessionStorage.getItem('esRetoDiario') === 'true';

        if (!temaSeleccionado) {
            alert('No se seleccion√≥ ning√∫n tema');
            window.location.href = 'vistaTemas.html';
        }

        const hangmanImage = document.querySelector(".hangman-box img");
        const wordDisplay = document.querySelector(".word-display");
        const keyboardDiv = document.querySelector(".keyboard");
        const gameModal = document.querySelector(".game-modal");
        const playAgainBtn = document.querySelector(".play-again");
        const heartsContainer = document.querySelector(".hearts-container");
        const retoBadge = document.getElementById("reto-badge");
        const temaNombre = document.getElementById("tema-nombre");
        const palabraActualEl = document.getElementById("palabra-actual");
        const totalPalabrasEl = document.getElementById("total-palabras");
        const backgroundMusic = document.getElementById('background-music');

        let sonidosActivados = false;
        let currentWord, correctLetters, wrongGuessCount;
        const maxGuesses = 6;
        let palabrasCifradas = [];
        let palabraIndex = 0;
        let palabrasDelTema = [];
        let modoOffline = false;

        // ============================================
        // ESCUCHAR SINCRONIZACI√ìN
        // ============================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'SYNC_RESULTADO') {
                    if (event.data.sincronizadas > 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }
            });
        }

        // ============================================
        // INDEXEDDB
        // ============================================
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ahorcaditoDB', 3);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Crear store de temas si no existe
                    if (!db.objectStoreNames.contains('temas')) {
                        db.createObjectStore('temas', { keyPath: 'idTema' });
                    }

                    // Crear store de progreso local si no existe
                    if (!db.objectStoreNames.contains('progreso-local')) {
                        db.createObjectStore('progreso-local', { keyPath: 'idTema' });
                    }

                    if (!db.objectStoreNames.contains('racha-cache')) {
                        db.createObjectStore('racha-cache', { keyPath: 'id' });
                    }
                };
            });
        }

        // ============================================
        // GUARDAR PROGRESO LOCAL (CR√çTICO)
        // ============================================
        async function guardarProgresoLocal(idTema, palabraIndex, palabrasCompletadas) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['progreso-local'], 'readwrite');
                const store = transaction.objectStore('progreso-local');

                const progreso = {
                    idTema: idTema,
                    palabraActualIndex: palabraIndex,
                    palabrasCompletadas: palabrasCompletadas,
                    timestamp: Date.now()
                };

                await new Promise((resolve, reject) => {
                    const request = store.put(progreso);
                    request.onsuccess = () => {
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
            }
        }

        // ============================================
        // CARGAR PROGRESO LOCAL
        // ============================================
        async function cargarProgresoLocal(idTema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['progreso-local'], 'readonly');
                const store = transaction.objectStore('progreso-local');

                return new Promise((resolve, reject) => {
                    const request = store.get(idTema);
                    request.onsuccess = () => {
                        const progreso = request.result;
                        if (progreso) {
                        }
                        resolve(progreso || null);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return null;
            }
        }

        // ============================================
        // ACTUALIZAR TEMA EN INDEXEDDB
        // ============================================
        async function guardarTemaEnIndexedDB(tema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readwrite');
                const store = transaction.objectStore('temas');

                await new Promise((resolve, reject) => {
                    const request = store.put(tema);
                    request.onsuccess = () => {
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
            }
        }

        // ============================================
        // CARGAR TEMA DESDE INDEXEDDB
        // ============================================
        async function cargarTemaDesdeIndexedDB(idTema) {
            try {
                const db = await openIndexedDB();
                const transaction = db.transaction(['temas'], 'readonly');
                const store = transaction.objectStore('temas');

                return new Promise((resolve, reject) => {
                    const request = store.get(idTema);
                    request.onsuccess = () => {
                        const tema = request.result;
                        if (tema) {
                        }
                        resolve(tema || null);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                return null;
            }
        }

        // ============================================
        // CARGAR PREFERENCIAS
        // ============================================
        async function cargarPreferencias() {
            try {
                const response = await fetchConToken('/api/Auth/perfil');

                if (response.ok) {
                    const perfil = await response.json();
                    sonidosActivados = perfil.sonidosActivados;

                    if (sonidosActivados) {
                        backgroundMusic.volume = 0.3;
                        backgroundMusic.play().catch(err => {
                        });
                    }
                }
            } catch (error) {
            }
        }

        document.querySelector(".btn-regresar").addEventListener("click", function (e) {
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
            window.location.href = 'vistaTemas.html';
        });

        function descifrarPalabra(palabraCifrada) {
            try {
                return atob(palabraCifrada);
            } catch (e) {
                return '';
            }
        }

        function actualizarInfoTema() {
            temaNombre.textContent = temaSeleccionado.nombre;
            palabraActualEl.textContent = palabraIndex + 1;
            totalPalabrasEl.textContent = temaSeleccionado.totalPalabras || 10;

            if (esRetoDiario) {
                retoBadge.style.display = 'flex';
            }
        }

        function actualizarCorazones() {
            const hearts = heartsContainer.querySelectorAll('.heart');
            hearts.forEach((heart, index) => {
                if (index < maxGuesses - wrongGuessCount) {
                    heart.style.opacity = '1';
                    heart.textContent = '‚ù§Ô∏è';
                } else {
                    heart.style.opacity = '0.3';
                    heart.textContent = 'üñ§';
                }
            });
        }

        const resetGame = () => {
            correctLetters = [];
            wrongGuessCount = 0;
            hangmanImage.src = `images/hangman-${wrongGuessCount}.svg`;

            keyboardDiv.querySelectorAll("button").forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('correct', 'incorrect');
            });

            wordDisplay.innerHTML = currentWord.split("").map(() => `<li class="letter"></li>`).join("");
            gameModal.classList.remove("show");
            actualizarCorazones();
            actualizarInfoTema();
        }

        // ============================================
        // CARGAR PALABRAS - MEJORADO CON PERSISTENCIA (CORREGIDO)
        // ============================================
        async function cargarPalabrasTema() {
            try {
                // 1. CARGAR PROGRESO LOCAL PRIMERO
                const progresoLocal = await cargarProgresoLocal(temaSeleccionado.idTema);
                if (esRetoDiario) {
                    try {
                        // Intentar obtener datos del servidor
                        const response = await fetchConToken('/api/Juego/iniciar-diario');

                        if (response.ok) {
                            const retoDiario = await response.json();

                            if (retoDiario.yaCompletadoHoy) {
                                alert('¬°Ya completaste el reto de hoy!');
                                window.location.href = 'index.html';
                                return;
                            }

                            // APLICAR PROGRESO LOCAL SI ES MAYOR
                            if (progresoLocal && progresoLocal.palabrasCompletadas > retoDiario.palabrasCompletadas) {
                                palabraIndex = progresoLocal.palabraActualIndex;
                                temaSeleccionado.palabrasCompletadas = progresoLocal.palabrasCompletadas;
                            } else {
                                palabraIndex = retoDiario.palabraActualIndex;
                                temaSeleccionado.palabrasCompletadas = retoDiario.palabrasCompletadas;
                            }

                            // Cargar palabras del tema
                            palabrasCifradas = retoDiario.palabrasCifradas || temaSeleccionado.palabrasCifradas;
                            palabrasDelTema = palabrasCifradas.map(p => descifrarPalabra(p));
                            currentWord = palabrasDelTema[palabraIndex];

                            modoOffline = false;
                        }
                    } catch (error) {
                        modoOffline = true;

                        // CARGAR DESDE INDEXEDDB CON PROGRESO LOCAL
                        const temaCache = await cargarTemaDesdeIndexedDB(temaSeleccionado.idTema);

                        if (!temaCache) {
                            alert('No hay datos offline disponibles para el reto diario');
                            window.location.href = 'vistaTemas.html';
                            return;
                        }

                        // USAR PROGRESO LOCAL SI EXISTE
                        if (progresoLocal) {
                            palabraIndex = progresoLocal.palabraActualIndex;
                            temaSeleccionado.palabrasCompletadas = progresoLocal.palabrasCompletadas;
                        } else {
                            palabraIndex = temaCache.palabrasCompletadas || 0;
                            temaSeleccionado.palabrasCompletadas = temaCache.palabrasCompletadas || 0;
                        }

                        // Verificar si ya complet√≥ el tema
                        palabrasCifradas = temaCache.palabrasCifradas || temaSeleccionado.palabrasCifradas;

                        if (palabraIndex >= palabrasCifradas.length) {
                            alert('¬°Ya completaste el reto de hoy!');
                            window.location.href = 'index.html';
                            return;
                        }

                        palabrasDelTema = palabrasCifradas.map(p => descifrarPalabra(p));
                        currentWord = palabrasDelTema[palabraIndex];
                    }
                } else {
                    // 2. TEMA NORMAL
                    if (progresoLocal) {
                        palabraIndex = progresoLocal.palabraActualIndex;
                        temaSeleccionado.palabrasCompletadas = progresoLocal.palabrasCompletadas;
                    } else {
                        palabraIndex = temaSeleccionado.palabrasCompletadas || 0;
                    }

                    // 3. INTENTAR CARGAR DESDE SERVIDOR
                    try {
                        const response = await fetchConToken(`/api/Temas/${temaSeleccionado.idTema}`);

                        if (response.ok) {
                            const temaActualizado = await response.json();

                            // Usar el progreso m√°s alto (local o servidor)
                            if (progresoLocal && progresoLocal.palabrasCompletadas > temaActualizado.palabrasCompletadas) {
                                palabraIndex = progresoLocal.palabraActualIndex;
                                temaSeleccionado.palabrasCompletadas = progresoLocal.palabrasCompletadas;
                            } else {
                                palabraIndex = temaActualizado.palabrasCompletadas;
                                temaSeleccionado.palabrasCompletadas = temaActualizado.palabrasCompletadas;
                            }

                            palabrasCifradas = temaActualizado.palabrasCifradas || temaSeleccionado.palabrasCifradas;
                            await guardarTemaEnIndexedDB(temaActualizado);
                        }
                    } catch (error) {
                        modoOffline = true;
                    }

                    // 4. CARGAR TEMA DESDE INDEXEDDB SI NO HAY CONEXI√ìN
                    const temaCache = await cargarTemaDesdeIndexedDB(temaSeleccionado.idTema);
                    if (temaCache) {
                        palabrasCifradas = temaCache.palabrasCifradas || temaSeleccionado.palabrasCifradas;
                    } else {
                        palabrasCifradas = temaSeleccionado.palabrasCifradas || [];
                    }

                    if (palabraIndex >= palabrasCifradas.length) {
                        alert('¬°Ya completaste todas las palabras de este tema!');
                        window.location.href = 'vistaTemas.html';
                        return;
                    }

                    palabrasDelTema = palabrasCifradas.map(p => descifrarPalabra(p));
                    currentWord = palabrasDelTema[palabraIndex];
                }

                // VALIDACI√ìN FINAL
                if (!currentWord || currentWord === '') {
                    alert('Error al cargar la palabra');
                    window.location.href = 'vistaTemas.html';
                    return;
                }
                resetGame();
            } catch (error) {
                alert('Error de conexi√≥n al cargar el juego');
            }
        }

        // ============================================
        // ACTUALIZAR PROGRESO
        // ============================================
        async function actualizarProgreso(resultado) {

            // 1. ACTUALIZAR LOCALMENTE PRIMERO
            if (resultado === 'GANADA') {
                palabraIndex++;
                temaSeleccionado.palabrasCompletadas++;

                // Actualizar tema en IndexedDB
                await guardarTemaEnIndexedDB(temaSeleccionado);
            }

            // 2. GUARDAR PROGRESO LOCAL SIEMPRE
            await guardarProgresoLocal(
                temaSeleccionado.idTema,
                palabraIndex,
                temaSeleccionado.palabrasCompletadas
            );

            // 3. VERIFICAR SI COMPLET√ì EL TEMA (10/10)
            if (resultado === 'GANADA' && temaSeleccionado.palabrasCompletadas === 10) {
                await registrarTemaCompletadoOffline(temaSeleccionado.idTema, esRetoDiario);
            }

            // 3. INTENTAR SINCRONIZAR CON SERVIDOR
            if (!navigator.onLine) {
                return;
            }

            try {
                const response = await fetchConToken('/api/Juego/actualizar-progreso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idTema: temaSeleccionado.idTema,
                        palabraActualIndex: palabraIndex - (resultado === 'GANADA' ? 1 : 0),
                        resultado: resultado
                    })
                });

                if (response.ok) {
                }
            } catch (error) {
            }
        }

        // Registrar tema completado offline
        async function registrarTemaCompletadoOffline(idTema, esRetoDiario) {
            try {
                const db = await openIndexedDB();
                const tx = db.transaction(['racha-cache'], 'readwrite');
                const store = tx.objectStore('racha-cache');

                // Obtener racha actual
                const rachaActual = await new Promise((resolve, reject) => {
                    const request = store.get('racha-local');
                    request.onsuccess = () => resolve(request.result || {
                        id: 'racha-local',
                        temasCompletados: 0,
                        diasCompletados: [],
                        palabrasTotales: 0,
                        timestamp: Date.now()
                    });
                    request.onerror = () => reject(request.error);
                });

                // Actualizar racha
                rachaActual.temasCompletados = (rachaActual.temasCompletados || 0) + 1;
                rachaActual.palabrasTotales = (rachaActual.palabrasTotales || 0) + 10;

                // Si es reto diario, marcar d√≠a como completado
                if (esRetoDiario) {
                    const hoy = new Date().getDay(); // 0=Dom, 1=Lun, etc.
                    if (!rachaActual.diasCompletados) {
                        rachaActual.diasCompletados = [];
                    }
                    if (!rachaActual.diasCompletados.includes(hoy)) {
                        rachaActual.diasCompletados.push(hoy);
                    }
                }

                rachaActual.timestamp = Date.now();

                await new Promise((resolve, reject) => {
                    const request = store.put(rachaActual);
                    request.onsuccess = () => {
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });

            } catch (error) {
            }
        }

        // ============================================
        // FETCH CON RENOVACI√ìN AUTOM√ÅTICA DE TOKEN
        // ============================================
        async function fetchConToken(url, options = {}) {
            let response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
            });

            if (response.status === 401) {

                const renewResponse = await fetch('/api/Auth/renew', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (renewResponse.ok) {
                    const nuevoToken = await renewResponse.text();
                    localStorage.setItem('jwtToken', nuevoToken);

                    response = await fetch(url, {
                        ...options,
                        headers: {
                            ...options.headers,
                            'Authorization': `Bearer ${nuevoToken}`
                        }
                    });
                } else {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            }

            return response;
        }

        const gameOver = async (isVictory) => {
            setTimeout(async () => {
                if (isVictory) {
                    // VICTORIA
                    gameModal.querySelector("img").src = "images/victory.gif";
                    gameModal.querySelector("h4").innerText = "¬°Felicidades!";
                    gameModal.querySelector("p").innerHTML =
                        `¬°Encontraste la palabra: <b>${currentWord.toUpperCase()}</b>`;

                    await actualizarProgreso('GANADA');
                } else {
                    // DERROTA
                    gameModal.querySelector("img").src = "images/lost.gif";
                    gameModal.querySelector("h4").innerText = "Game Over!";
                    gameModal.querySelector("p").innerText =
                        `¬°Vuelve a intentarlo, √ÅNIMO`;

                    await actualizarProgreso('PERDIDA');
                }

                gameModal.classList.add("show");
            }, 300);
        }

        const initGame = (button, clickedLetter) => {
            if (currentWord.toLowerCase().includes(clickedLetter)) {
                button.classList.add('correct');
                [...currentWord.toLowerCase()].forEach((letter, index) => {
                    if (letter === clickedLetter) {
                        correctLetters.push(letter);
                        wordDisplay.querySelectorAll("li")[index].innerText = currentWord[index].toUpperCase();
                        wordDisplay.querySelectorAll("li")[index].classList.add("guessed");
                    }
                });
            } else {
                button.classList.add('incorrect');
                wrongGuessCount++;
                hangmanImage.src = `images/hangman-${wrongGuessCount}.svg`;
                actualizarCorazones();
            }

            button.disabled = true;

            if (wrongGuessCount === maxGuesses) return gameOver(false);
            if (correctLetters.length === currentWord.length) return gameOver(true);
        }

        // ============================================
        // CREAR TECLADO
        // ============================================
        for (let i = 97; i <= 110; i++) {
            const char = String.fromCharCode(i);
            const button = document.createElement("button");
            button.innerText = char.toUpperCase();
            keyboardDiv.appendChild(button);
            button.addEventListener("click", e => initGame(e.target, char));
        }

        const buttonNtilde = document.createElement("button");
        buttonNtilde.innerText = "√ë";
        keyboardDiv.appendChild(buttonNtilde);
        buttonNtilde.addEventListener("click", e => initGame(e.target, "√±"));

        for (let i = 111; i <= 122; i++) {
            const char = String.fromCharCode(i);
            const button = document.createElement("button");
            button.innerText = char.toUpperCase();
            keyboardDiv.appendChild(button);
            button.addEventListener("click", e => initGame(e.target, char));
        }

        playAgainBtn.addEventListener("click", async function () {
            if (esRetoDiario) {
                await cargarPalabrasTema();
            } else {
                if (palabraIndex < palabrasDelTema.length) {
                    currentWord = palabrasDelTema[palabraIndex];
                    resetGame();
                } else {
                    alert('¬°Completaste todas las palabras de este tema!');
                    sessionStorage.removeItem('temaSeleccionado');
                    sessionStorage.removeItem('esRetoDiario');

                    if (backgroundMusic) {
                        backgroundMusic.pause();
                        backgroundMusic.currentTime = 0;
                    }

                    window.location.href = 'vistaTemas.html';
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            cargarPreferencias();
            cargarPalabrasTema();
        });

        window.addEventListener('beforeunload', function () {
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        });
    </script>
</body>
</html>